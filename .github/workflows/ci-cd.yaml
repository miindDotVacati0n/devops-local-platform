name: CI-CD (Self Hosted)

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: m31llow/backend
  KUBE_NAMESPACE: backend

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    # -------------------------
    # 1. Checkout source code
    # -------------------------
    - name: Checkout
      uses: actions/checkout@v4

    # -------------------------
    # 2. Set image tag
    # -------------------------
    - name: Set IMAGE_TAG
      run: |
        echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

    # -------------------------
    # 3. Docker login
    # -------------------------
    - name: Docker Login
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
          -u "${{ secrets.DOCKER_USERNAME }}" \
          --password-stdin

    # -------------------------
    # 4. Build & Push image
    # -------------------------
    - name: Build & Push Backend Image
      run: |
        docker build \
          -t $IMAGE_NAME:${IMAGE_TAG} \
          applications/backend

        docker push $IMAGE_NAME:${IMAGE_TAG}

    # -------------------------
    # 5. Prepare Kubernetes manifests
    # -------------------------
    - name: Prepare Kubernetes YAML
      run: |
        sed -i "s|IMAGE_TAG|${IMAGE_TAG}|g" k8s/backend/backend.yaml

    # -------------------------
    # 6. Ensure namespace exists
    # -------------------------
    - name: Ensure Namespace
      run: |
        kubectl get ns $KUBE_NAMESPACE || \
        kubectl create namespace $KUBE_NAMESPACE

    # -------------------------
    # 7. Deploy to Kubernetes
    # -------------------------
    - name: Deploy Backend
      run: |
        kubectl apply -n $KUBE_NAMESPACE -f k8s/backend/

    # -------------------------
    # 8. Force rollout (IMPORTANT)
    # -------------------------
    - name: Rollout Restart
      run: |
        kubectl rollout restart deployment backend -n $KUBE_NAMESPACE

    # -------------------------
    # 9. Wait for rollout
    # -------------------------
    - name: Wait for Rollout
      run: |
        kubectl rollout status deployment backend -n $KUBE_NAMESPACE
