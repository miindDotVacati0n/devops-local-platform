name: Backend CI/CD (Self Hosted)

on:
  push:
    branches: [main]
    paths:
      - "applications/backend/**"
      - "k8s/backend/**"

env:
  IMAGE_NAME: m31llow/backend
  KUBE_NAMESPACE: backend

jobs:
  deploy-backend:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v4

    - name: Set IMAGE_TAG
      run: echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

    - name: Docker Login
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
          -u "${{ secrets.DOCKER_USERNAME }}" \
          --password-stdin

    - name: Build & Push Image
      run: |
        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} applications/backend
        docker push ${IMAGE_NAME}:${IMAGE_TAG}

    - name: Render Backend YAML
      run: |
        envsubst < k8s/backend/backend.yaml > k8s/backend/backend.rendered.yaml

    - name: Ensure Namespace
      run: |
        kubectl get ns ${KUBE_NAMESPACE} || kubectl create ns ${KUBE_NAMESPACE}

    - name: Deploy Backend
      run: |
        kubectl apply -n ${KUBE_NAMESPACE} -f k8s/backend/backend.rendered.yaml
        kubectl apply -n ${KUBE_NAMESPACE} -f k8s/backend/service.yaml

    - name: Rollout Restart
      run: |
        kubectl rollout restart deployment backend -n ${KUBE_NAMESPACE}

    - name: Wait for Rollout
      run: |
        kubectl rollout status deployment backend -n ${KUBE_NAMESPACE}
